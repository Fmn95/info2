#include "factory.h"
#include "parser.h"
static double parse_km3(const char *s){ if(!s) return 0.0; if(strcmp(s,"-")==0) return 0.0; return strtod(s,NULL);}
factory_info_t *factory_info_create(const char *id){ factory_info_t *f=calloc(1,sizeof(*f)); f->id=xstrdup(id); return f;}
void factory_info_free(void *v){ factory_info_t *f=v; if(!f) return; free(f->id); free(f);}
struct avl_tree *build_factories_from_csv(FILE *f){ struct avl_tree *t=avl_create(); char line[MAX_LINE_LEN]; while(fgets(line,sizeof(line),f)){ csv_line_t *row=csv_line_parse(line); if(!row) continue; if(row->type==LINE_FACILITY){ double cap=parse_km3(row->col4); factory_info_t *fi=avl_get(t,row->col2); if(!fi){ fi=factory_info_create(row->col2); fi->capacity_km3=cap; avl_insert(t,fi->id,fi);} else fi->capacity_km3=cap; } else if(row->type==LINE_SOURCE_TO_FAC){ double vol=parse_km3(row->col4); const char *facid=row->col3; factory_info_t *fi=avl_get(t,facid); if(!fi){ fi=factory_info_create(facid); fi->sources_km3=vol; avl_insert(t,fi->id,fi);} else fi->sources_km3+=vol; } csv_line_free(row);} return t;}